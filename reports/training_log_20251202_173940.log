--- Starting Training: Dueling_DDQN 20251202_173940 ---
--- Hyperparameters ---
device: cuda
seed: 42
keep_top_n: 1000
min_ratings: 5
val_ratio: 0.2
data_rel_path: data/ml-latest-small
model_base: models/dqn_movielens.pt
model_finetuned: models/dqn_movielens_finetuned.pt
plot_summary: reports/figures/training_summary.png
model_arch: Dueling
use_double_q: True
history_window: 10
hidden_dim: 256
dropout_rate: 0.2
buffer_size: 100000
batch_size: 512
learning_rate: 0.0001
gamma: 0.7
target_update: 500
base_n_updates: 10000
log_interval: 500
weight_decay: 1e-05
repeat_penalty: 1
popularity_penalty: 0.2
ft_n_steps: 2000
ft_batch_size: 32
ft_lr: 1e-05
ft_weight_decay: 1e-05
margin: 0.5
neg_per_pos: 5
use_candidates: True
candidate_k: 200
frac_candidate: 0.5
---- Architecture: Dueling | Algorithm: DDQN ------
Total unique movies with ratings before filtering: 9724
Filtered to top 1000 movies. Remaining Ratings: 61256
Filtered users with < 5 ratings. Ratings dropped: 3
[RecoEnv] state_dim=200, n_actions=1000, repeat_penalty=1, popularity_penalty=0.2  
Mode=Flattened 
train_transitions=96990, val_transitions=24250
[RecoEnv] reward(train): min=-1.426, max=0.997, mean=-0.118
Sample train rewards: [ 0.8776923  -0.5         0.97692305 -0.5         0.4076923  -0.5
  0.4823077  -0.5         0.90076923 -0.5         0.47230768 -0.5
  0.8676923  -0.5         0.47153845 -0.5         0.43461537 -0.5
  0.44846153 -0.5       ]
DuelingDQN(
  (feature_layer): Sequential(
    (0): Linear(in_features=200, out_features=256, bias=True)
    (1): ReLU()
    (2): Dropout(p=0.2, inplace=False)
    (3): Linear(in_features=256, out_features=256, bias=True)
  )
  (value_stream): Sequential(
    (0): Linear(in_features=256, out_features=256, bias=True)
    (1): ReLU()
    (2): Linear(in_features=256, out_features=1, bias=True)
  )
  (advantage_stream): Sequential(
    (0): Linear(in_features=256, out_features=256, bias=True)
    (1): ReLU()
    (2): Linear(in_features=256, out_features=1000, bias=True)
  )
)
[Agent] Preloaded 96990 transitions into replay buffer.
Loading Train/Validation Data...
--- Loading Data (Top 1000 movies, Min 5 ratings) ---
Total unique movies with ratings before filtering: 9724
Filtered to top 1000 movies. Remaining Ratings: 61256
Filtered users with < 5 ratings. Ratings dropped: 3
Starting training for 10000 steps...
Step  200 | Loss: 0.1287 | NDCG@10: 0.1270 | Avg Q: -0.168
--- Best Model Saved!
Step  400 | Loss: 0.1243 | NDCG@10: 0.1547 | Avg Q: -0.214
--- Best Model Saved!
Step  600 | Loss: 0.1227 | NDCG@10: 0.1569 | Avg Q: 0.013
--- Best Model Saved!
Step  800 | Loss: 0.1209 | NDCG@10: 0.1705 | Avg Q: -0.002
--- Best Model Saved!
Step 1000 | Loss: 0.1197 | NDCG@10: 0.1789 | Avg Q: 0.020
--- Best Model Saved!
Step 1200 | Loss: 0.1188 | NDCG@10: 0.1844 | Avg Q: 0.203
--- Best Model Saved!
Step 1400 | Loss: 0.1178 | NDCG@10: 0.1893 | Avg Q: 0.217
--- Best Model Saved!
Step 1600 | Loss: 0.1168 | NDCG@10: 0.1712 | Avg Q: 0.321
Step 1800 | Loss: 0.1158 | NDCG@10: 0.1916 | Avg Q: 0.324
--- Best Model Saved!
Step 2000 | Loss: 0.1147 | NDCG@10: 0.1869 | Avg Q: 0.324
Step 2200 | Loss: 0.1140 | NDCG@10: 0.2080 | Avg Q: 0.473
--- Best Model Saved!
Step 2400 | Loss: 0.1132 | NDCG@10: 0.1747 | Avg Q: 0.459
Step 2600 | Loss: 0.1125 | NDCG@10: 0.1982 | Avg Q: 0.650
Step 2800 | Loss: 0.1117 | NDCG@10: 0.1872 | Avg Q: 0.624
Step 3000 | Loss: 0.1110 | NDCG@10: 0.1986 | Avg Q: 0.639
Step 3200 | Loss: 0.1103 | NDCG@10: 0.1930 | Avg Q: 0.724
Step 3400 | Loss: 0.1096 | NDCG@10: 0.1802 | Avg Q: 0.768
Step 3600 | Loss: 0.1089 | NDCG@10: 0.1909 | Avg Q: 0.860
Step 3800 | Loss: 0.1082 | NDCG@10: 0.2011 | Avg Q: 0.856
Step 4000 | Loss: 0.1075 | NDCG@10: 0.1654 | Avg Q: 0.845
Step 4200 | Loss: 0.1069 | NDCG@10: 0.1684 | Avg Q: 0.965
Step 4400 | Loss: 0.1063 | NDCG@10: 0.2025 | Avg Q: 0.972
Step 4600 | Loss: 0.1056 | NDCG@10: 0.1948 | Avg Q: 1.037
Step 4800 | Loss: 0.1049 | NDCG@10: 0.2015 | Avg Q: 1.021
Step 5000 | Loss: 0.1043 | NDCG@10: 0.1950 | Avg Q: 1.010
Step 5200 | Loss: 0.1037 | NDCG@10: 0.1959 | Avg Q: 1.116
Step 5400 | Loss: 0.1031 | NDCG@10: 0.1835 | Avg Q: 1.137
Step 5600 | Loss: 0.1025 | NDCG@10: 0.1829 | Avg Q: 1.199
Step 5800 | Loss: 0.1020 | NDCG@10: 0.1711 | Avg Q: 1.218
Step 6000 | Loss: 0.1014 | NDCG@10: 0.1871 | Avg Q: 1.228
Step 6200 | Loss: 0.1009 | NDCG@10: 0.1936 | Avg Q: 1.333
Step 6400 | Loss: 0.1004 | NDCG@10: 0.1684 | Avg Q: 1.318
Step 6600 | Loss: 0.0999 | NDCG@10: 0.1723 | Avg Q: 1.475
Step 6800 | Loss: 0.0995 | NDCG@10: 0.1844 | Avg Q: 1.443
Step 7000 | Loss: 0.0990 | NDCG@10: 0.1696 | Avg Q: 1.452
Step 7200 | Loss: 0.0985 | NDCG@10: 0.1710 | Avg Q: 1.495
Step 7400 | Loss: 0.0981 | NDCG@10: 0.1757 | Avg Q: 1.546
Step 7600 | Loss: 0.0976 | NDCG@10: 0.1652 | Avg Q: 1.662
Step 7800 | Loss: 0.0972 | NDCG@10: 0.1665 | Avg Q: 1.628
Step 8000 | Loss: 0.0968 | NDCG@10: 0.1700 | Avg Q: 1.603
Step 8200 | Loss: 0.0964 | NDCG@10: 0.1624 | Avg Q: 1.677
Step 8400 | Loss: 0.0960 | NDCG@10: 0.1557 | Avg Q: 1.654
Step 8600 | Loss: 0.0956 | NDCG@10: 0.1625 | Avg Q: 1.734
Step 8800 | Loss: 0.0952 | NDCG@10: 0.1566 | Avg Q: 1.776
Step 9000 | Loss: 0.0947 | NDCG@10: 0.1559 | Avg Q: 1.738
Step 9200 | Loss: 0.0944 | NDCG@10: 0.1484 | Avg Q: 1.845
Step 9400 | Loss: 0.0940 | NDCG@10: 0.1516 | Avg Q: 1.804
Step 9600 | Loss: 0.0936 | NDCG@10: 0.1566 | Avg Q: 1.876
Step 9800 | Loss: 0.0932 | NDCG@10: 0.1543 | Avg Q: 1.913
Step 10000 | Loss: 0.0929 | NDCG@10: 0.1672 | Avg Q: 1.852
Training Complete!
 > Model saved to: /Users/lingyunguo/Documents/ECE1508RL_project/models/Dueling_DDQN_20251202_173940.pt
 > Plot saved to:  /Users/lingyunguo/Documents/ECE1508RL_project/reports/figures/Dueling_DDQN_20251202_173940.png
 > Log saved to:   /Users/lingyunguo/Documents/ECE1508RL_project/reports/training_log_20251202_173940.log
